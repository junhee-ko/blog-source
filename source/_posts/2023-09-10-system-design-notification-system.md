---
layout: post
title: "알림 시스템 설계" 
date: 2023-09-10
categories: Design
---

고객에게 비동기적으로 알림을 제공할 수 있는 시스템을 설계해본다.

## 알림 전송 및 수신 절차

1. 1부터 N 까지의 서비스: 이 서비스 각각은 마이크로서비스일 수도 있고, 크론잡일 수도 있고, 분산 시스템 컴포넌틀 일 수 있다.
2. 알림 시스템: 알림 전송/수신 처리의 핵심이다. 우선 한 대의 서버만 사용하는 시스템이라고 하자. 이 시스템은 1부터 N 까지의 서비스에 알림 전송을 위한 API 를 제공해야하고, 제 3자 서비스에 전달할 알림 payload 를 만들어야한다.
3. 제 3자 서비스: 사용자에게 알림을 실제로 전달한다. (APNS, FCM ...)

이 방식의 문제는,

1. Single Point of Failure: 알림 서비스에 서버가 한 대 밖에 없으면 서버에 장애가 생기면, 전체 서비스의 장애로 이어진다.
2. 규모 확장성: 한 대 서비스로 푸쉬 알림에 관련된 모든 것을 처리하므로, 데이터베이스나 캐쉬 등 중요 컴포넌트의 규모를 개별적으로 늘리기 어렵다.
3. 성능 병목: 알림을 처리하고 보내는 것은 자원을 많이 필요로 작업인데, 모든 것을 한 서버로 처리하면 사용자 트래픽이 많이 몰리는 시간에 시스템이 과부하 상태에 빠질 수 있다.

그래서, 다음과 같은 방향으로 개선할 수 있다.

1. 데이터베이스와 캐쉬를 알림 시스템의 주 서버에서 분리한다.
2. 알림 서버를 증설하고 자동으로 수평적 규모 확장을 할 수 있도록 한다.
3. 메세지 큐를 이용해서 시스템 컴포넌트 사이의 강한 결합을 끊는다.

이 컴포넌트들은 다음처럼 협력해서 알림을 전송한다.

1. API 를 호출해서 알림 서버로 알림을 보낸다.
2. 알림 서버는 사용자 정보, 단말 토큰, 알림 설정 같은 metadata 를 캐쉬나 데이터베이스에서 가져온다.
3. 알림 서버는 전송할 알림에 맞는 이벤트를 만들어서 해당 이벤트를 위한 큐에 넣는다. 예를 들어, iOS 푸쉬 알림 이벤트는 iOS 푸쉬 알림 큐에 넣는다.
4. 작업 서버는 메세지 큐에서 알림 이벤트를 꺼낸다.
5. 작업 서버는 알림을 제 3자 서비스로 보낸다.
6. 제 3자 서비스는 사용자 단말로 알림을 전송한다.

## 안정성

분산 환경에서 운영되는 알림 시스템을 설계할 때는 안정성을 확보하기 위한 몇 가지 사항을 고려해야한다.

### 데이터 손실 방지

알림이 지연되거나 순서가 틀려도 괜찮지만, 알림이 소실되면 안된다고 해보자.
이 요구 사항을 만족하려면 알림 데이터를 DB 에 보관하고, 재시도 매커니즘을 구현해야한다.
알림 로그 DB 를 유지하는 것이 한 가지 방법이다.

### 알림 중복 전송 방지

중복 발송 방지를 위해, 보내야할 알림이 도착하면 그 이벤트 ID 를 검사해서 이전에 본 적이 있는 이벤트인지 판단한다.
중복된 이벤트이면 버리고, 중복된 이벤트가 아니면 알림을 발송한다.

## 추가 고려사항

알림 시스템 구현을 위해 필요한 추가 컴포넌트들에 대해 정리하자.

### 알림 테플릿

알림 메세지는 대부분 형식이 비슷해서, 알림 템플릿을 만들어 모든 부분을 처음부터 다시 만들지 않도록 할 수 있다.
전송될 알림들의 형식을 일관성 있게 유지할 수 있고, 오류 가능성도 줄일 수 있다.

### 알림 설정

사용자가 알림 설정을 조정할 수 있도록 하고, 이 정보들을 알림 설정 테이블에 보관한다.

- user_id (bigint)
- channel (varchar): 알림 전송 채널. 푸쉬알림/이메일/SMS
- opt_in (boolean): 알림을 받을 것인지 여부

### 전송류 제한

한 사용자가 받을 수 있는 알림의 빈도를 제한할 수 있다.

### 재시도

제 3자 서비스가 알림 전송에 실패하면, 해당 알림을 재시도 전용 큐에 넣는다.
같은 문제가 지속되면 개발자에게 alert 한다.

### 푸쉬 알림과 보안

iOS 와 안드로이드 앱의 경우, 알림 전송 API 는 appKey 와 appSecret 을 사용해서 보안을 유지한다.
authenticated, verified 클라이언트만 알림 전송 API 를 사용해서 알림을 보낼 수 있다.

### 큐 모니터링

큐에 쌓인 알림의 개수는 중요한 metric 이다.
이 수가 너무 크면 작업 서버들이 이벤트를 빠르게 처리할고 있지 못한다는 뜻이다. 
이 경우, 작업 서버를 증설해서 해결할 수 있다.

### 이벤트 추적

알림 확인률, 클릭률, 실제 앱 사용으로 이어지는 비율 같은 메트릭은 사용자를 이해하는데 중요하다.
데이터 분석 서비스는 보통 이벤트 추적 기능을 제공하기 때문에, 알림 시스템을 데이터 분석 서비스와 통합할 수 있디. 

---

System Design Interview <알렉스 쉬>
