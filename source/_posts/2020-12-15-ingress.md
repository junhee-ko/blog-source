---
layout: post
title: "인그레스"
date: 2020-12-15
categories: K8S
---

인그레스는, 외부 요청을 어떻게 처리할 것인지 네트워크 7 계층 레벨에서 정의하는 오브젝트이다.
핵심 기능은,

1. 외부 요청의 라우팅: 특정 경로로 들어온 요청을 어떤 서비스로 전달할지 정의
2. 가상 호스트 기반 요청 처리: 같은 IP 에 대해 다른 도메인 이름으로 요청이 들어왔을 때, 어떻게 처리할지 정의
3. SSL/TLS 보안 열결: 여러 서비스로 요청을 라우팅할 때, 보안 연결을 위한 인증서를 적용

## 사용 이유

![](/image/deployment-service.png)

어플리케이션이  개의 디플로이먼트로 생성되어 있다고 하자.
디플로이먼트를 외부에 노출하려면 위 그림 처럼, NodePort or LoadBalancer 타입의 서비스 3 개를 각각 디플로이먼트에 연결하면 된다.

그런데, 이 방식은 서비스마다 세부적인 설정을 할 때 추가적인 복잡성이 발생한다.
예를 들면, 아래와 같은 내용을 구현하려면, 서비스와 디플로이먼트에 대해 일일이 설정해야한다.

1. SSL/TLS 보안 연결
2. 접근 도메인 및 클라이언트 상태에 기반한 라우팅

인그레스 오브젝트를 이용하면, URL 엔드포인트를 단 하나만 생성해서 이런 번거로움을 해결할 수 있다.

![](/image/deployment-service-ingress.png)

위 그림처럼, 세 개의 서비스에 대해 세 개 URL 이 각각 존재하는 것이 아니라, 인그레스에 접근하기 위한 하나의 URL 만 존재한다.
클라이언트는 인그레스의 URL 로 접근하고 해당 요청은 인그레스에서 정의한 규칙에 따라 처리된 뒤 적절한 디플로이먼트의 포드로 전달된다.

핵심은, 라우팅 정의나 보안 연결 같은 세부 설정을 서비스와 디플로이먼트가 이니라 인그레스에 의해 수행된다는 것이다.

## 구조

인그레스를 생성하는 것만으로는 아무일도 일어나지 않는다.
인그레스는 요청 처리 규칙을 정의한 선언적인 오브젝트일 뿐, 외부 요청을 받는 서버가 아니기 때문이다.
그래서, 인그레스 컨트롤러라는 특수한 서버에 이 규칙을 적용해서 생성해야한다.

인그레스 컨트롤러의 종류로는 다음 것들이 있다.

1. Kong API Gateway : https://konghq.com/kong
2. GKE (Google Kubernetes Engine) : https://cloud.google.com/kubernetes-engine
3. Nginx 웹서버 인그레스 컨트롤러 : https://github.com/kubernetes/ingress-nginx

## 인그레스 컨트롤러 동작 원리

![](/image/ingress-controller-all.png)

인그레스를 사용하는 방법은,

1. Nginx 인그레스 컨트롤러 생성
2. Nginx 인그레스 컨트롤러를 외부로 노출하기 위한 서비스 생성
3. 요청 처리 규칙을 정의하는 인그레스 오브젝트 생성
4. Nginx 인그레스 컨트롤러로 들어온 요청은 인그레스 규칙에 따라 적절한 서비스로 전달

### 인그레스 리소스의 상태

위의 3번에서 인그레스 오브젝트를 생성만 하면, 인그레스 컨트롤러는 자동으로 인그레스를 로드해서 Nginx 웹 서버에 적용한다.
이것이 가능한 이유는, Nginx 인그레스 컨트롤러는 항상 인그레스 리소스의 상태를 지켜보고 있기 때문이다.

### bypass

특정 경로와 호스트 이름으로 유입된 요청은 인그레스에 의해 정의된 규칙에 따라 서비스로 전달된다.
하지만 실제로는, 요청이 실제로 서비스로 전달되지 않고 Nginx 인그레스 컨트롤러는 서비스에 의해 생성된 엔드 포인트로 요청을 직접 전달한다.
이러한 동작을 bypass 라고 한다.

---

시작하세요! 도커/쿠버네티스 <용찬호>