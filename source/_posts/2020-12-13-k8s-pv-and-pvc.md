---
layout: post
title: "퍼시스턴스 볼륨, 퍼시스턴스 볼륨 크레임"
date: 2020-12-12
categories: Infrastructure
---

DB 처럼 포드 내부에서 특정 데이터를 보유해야하는 stateful 애플리케이션의 경우, 포드의 데이터를 영속적으로 저장하기 위한 방법이 필요하다.
아래 방법들을 정리한다.

1. 로컬 볼륨
2. 네트워크 볼륨
3. PV, PVC

## 로컬 볼륨: hostPath, emptyDir

볼륨을 간단히 사용해볼 수 있는 두 가지 종류의 볼륨을 먼저 정리한다.

1. hostPath: 호스트와 볼륨을 공유하기 위해 사용
2. emptyDir: 포드의 컨테이너 간에 볼륨을 공유하기 위해 사용

### hostPath: 워커 노드의 로컬 디텍토리를 볼륨으로 사용

포드의 데이터를 보존할 수 있는 가장 간단한 방법은, 호스트의 데이터를 포드와 공유해 데이터를 저장하는 것이다.
Pod 를 생선하는 YAML 파일에 "spec.volumes" 항목에 볼륨을 정의한다.
포드 컨테이너의 YAML 에서 정의한 경로와 호스트의 YAML 에서 정의한 경로가 동일 디렉토리로 사용된다.

이 방식은, 디플로이먼트의 포드에 장애가 생겨 다른 노드로 옮겨지면, 이전 노드에 저장된 데이터를 사용할 수 없다.

### emptyDir: 포드 내의 컨테이너 간 임시 데이터 공유

emptyDir 볼륨은, 포드가 실행되는 도중에만 필요한 휘발성 데이터를 각 컨테이너가 함께 사용할 수 있도록 임시 저장 공간을 생성한다.

## 네트워크 볼륨

아래와 같은 다양한 종류의 네트워크 볼륨을 포드에 마운트할 수 있다.

1. NFS
2. AWS 의 EBS (Elastic Block Store)
3. Ceph
4. GlusterFS
5. ...

## PV, PVC 를 이용한 볼륨 관리

### PV, PVC 사용 이유

위의 방법들은, 포드의 YAML 파일에 볼륨의 정보를 직접 입력해야한다.
예를 들어,

1. MySQL 디플로이먼트를 배포하기 위한 YAML 파일을 작성한다고 해보자.
2. MySQL 은 상태를 가지는 애플리케이션이기 때문에 영속적 스토리지를 마운트해 데이터를 보관해야한다. 
3. 그래서, 여러 네트워크 볼륨 중 NFS 를 사용하기로 하면, MySQL 의 디플로이먼트를 정의하는 YAML 파일에 nfs 항목과 NFS 서버의 정보를 기입한다.

그래서, 해당 YAML 파일로 MySQL 을 생성하려면 반드시 NFS 를 사용해야한다.
만약, GlusterFS 를 네트워크 볼륨으로 사용하고 싶으면, 별도의 YAML 파일을 작성해야한다.

이런 불편함을 해결하기 위해 쿠버네티스는 PV 와 PVC 오프젝트를 제공한다.
이 두 오브젝트는 포드가 볼륨의 세부 사항을 몰라도 볼륨을 사용할 수 있도록 추상화해주는 역할을 한다.

### PV 와 PVC 를 사용하는 흐름

1. 퍼시스턴트 볼륨을 미리 생성한다.
2. 포드를 정의하는 YAML 파일에, 퍼시스턴트 볼륨 클레임 를 명시한다: 이 포드는 데이터를 영속 저장해야 하므로, 마운트할 수 있는 외부 볼륨이 필요하고 명시
3. 쿠버네티스는 퍼시스턴트 볼륨의 속성과 퍼시스턴트 볼륨 클레임의 요구사항이 일치하면 두 리소스를 매칭시켜 bind 한다.  

### PV 의 Life Cycle 과 Reclaim Policy

#### Life Cycle

PV 를 생성한 뒤, kubectl get pv 명령어로 목록을 확인하면 STATUS 라는 항목이 보인다.

1. Available: PV 가 사용 가능한지
2. Bound: PVC 와 연결되었는지

PV 와 연결된 PVC 를 삭제하면, PV 의 상태가 Released 상태로 변경된다.
PV 의 사용이 끝났다는 것을 의미하고, 해당 PV 는 다시 사용할 수 없다. 
하지만, 실제 데이터는 보존되어 있기 때문에 PV 를 삭제한 뒤 다시 생성하면 Available 상태의 볼륨을 다시 사용할 수 있다.

#### Reclaim Policy

PVC 를 삭제했을 때, PV 의 데이터를 어떻게 처리할지 별도 정의가 가능하다.
쿠버네티스는 이를 Reclaim Policy 라고 하고, Reclaim Policy 에는 다음이 있다.

1. Retain: 아무런 설정을 하지 않으면, 기본적으로 PV 의 데이터를 보존하는 Retain 을 사용한다.
2. Delete: PV 는 삭제되고 가능한 경우 연결된 외부 스토리지도 함께 삭제되어 볼륨에 저장되어 있던 파일들이 모두 유실된다.

---

시작하세요! 도커/쿠버네티스 <용찬호>