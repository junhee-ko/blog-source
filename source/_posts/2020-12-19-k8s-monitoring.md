---
layout: post
title: "쿠버네티스 모니터링"
date: 2020-12-19
categories: K8S
---

다음과 같은 상황에서 모니터링이 필요할 수 있다.

1. 사용자 요청이 몰려 부하가 발생할 때
2. 인프라 또는 애플리케이션이 장애가 발생할 때
3. 애플리케이션의 일반적인 리소스 사용 패턴을 파악할 때

k8s 는 모니터링을 위한 매트릭을 수집할 수 있도록 자체적으로 기능을 제공하지 않는다.

그래서, 여러 오픈소스 도구를 조합해서 구축하거나 상용 솔루션을 구입해서 사용하는 것이 일반적이다.
k8s 에서 가장 많이 사용되는 오픈소스 모니터링 DB 는 프로메테우스이다. 
그리고 수집된 데이터를 그라파나로 시각화하고, AlertManager 로 슬랙 알람을 보낼 수도 있다.  

## 모니터링 기본 구조

CAdvisor 는 컨테이너와 관련된 모니터링 데이터를 확인할 수 있는 모니터링 도구이다.

1. CAdvisor 가 /metrics 경로를 외부에 노출시킨다.
2. /metrics 경로로 요청을 보내면 key-value 쌍으로 구성된 메트릭 데이터를 반환한다. 
3. 이 매트릭 데이터를 프로메테우스 같은 시계열 데이터베이스에 저장한다.

이렇게, /metrics 경로를 외부체 노출시켜 데이터를 수집할 수 있도록 인터페이스를 제공하는 서버를 export 라고 한다.

## 모니터링 메트릭의 분류

크게 세 가지가 있다.

1. 인프라 수준: 호스트 레벨의 메트릭. ex) 호스트에서 사용 중인 파일 디스크립터 개수, 호스트에 마운트되어 있는 디스크 사용량
2. 컨테이너 수준: 컨테이너 레벨의 메트릭. ex) 컨테이너별 CPU 와 메모리 사용량, 컨테이너 프로세스 상태
3. 애플리케이션 수준: 애플리케이션 레벨에서 정의하는 매트릭

## k8s 모니터링 기초

쿠버네티스에서 자체적으로 모니터링 기능을 제공하지 않지만, 쿠버네티스에 메트릿을 수집해 사용할 수 있도록 몇 가지 add-on 을 제공한다.
add-on 이란, 필요에 따라 쿠버네티스에 내부에 설치해 추가적으로 기능을 활용할 수 있도록 제공하는 도구이다.

1. metrics-server: 포드의 오토스케일링, 사용 중인 리소스 확인 등이 가능
2. kube-state-metrics: 리소스의 상태에 관련된 메트릭을 제공. ex) 포드의 상태가 Running 인지. 디플로이먼트의 레플리카 개수가 몇 개인지
3. node-exporter: 파일 시스템, 네트워크 패킷 등 호스트 측면에서의 메트릭을 제공

---

시작하세요! 도커/쿠버네티스 <용찬호>