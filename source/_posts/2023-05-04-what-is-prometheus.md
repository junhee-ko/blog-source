---
layout: post
title: Prometheus
date: 2023-05-04
categories: Infrastructure
---

프로메테우스는, 매트릭 기반의 오픈소스 모니터링 시스템이다.

## Prometheus Architecture

Service Discovery 를 통해 데이터 수집 대상을 발견한다.
여기서, 수집 대상은 Exporter 를 통해 데이터 수집이 가능한 애플리케이션이나 서드파티 애플리케이션이다.
수집된 데이터가 저장되면 PromQL 을 이용해 데쉬보드에서 활용되거나, 알림 매니저를 통해 알림이 발송된다.

### Client Library

매트릭을 만들기 위한 계측 코드를 추가하기 위해, 클라이언트 라이브러리를 사용한다.
보통 2-3 줄의 코드로 메트릭 정의를 할 수 있고, 제어하려는 코드에 inline 으로 원하는 계측 기능을 추가할 수 있다.
이것을 Direct Instrumentation (직접 계측) 이라고 한다.

### Exporter

익스포터는 가져오고 싶은 매트릭을 애플리케이션 바로 옆에 배치하는 소프트웨어이다.

실행하는 모든 코드를 통제하거나 해당 코드에 항상 접근할 수 있는 것은 아니기에, Direct Instrumentation 으로 처리할 수 없는 경우가 있다.
예를 들어, 운영체제 커널이 HTTP 를 통해 프로메테우스 형식을 갖는 메트릭을 항상 출력하지는 않는다.

1. 익스포터는 프로메테우스로부터 요청을 받아서,
2. 애플리케이션에서 요청한 데이터를 수집하고
3. 데이터를 올바른 형식으로 변환해서
4. 프로메테우스에 대한 응답으로 데이터를 반환한다.

### Service Discovery

계측할 애플리케이션이 준비가 되고 익스포터가 실행되면 프로메테우스는 이들이 어디에 있는지 파악해야한다. 그래야, 

1. 프로메테우스는 무엇을 모니터링해야 할지를 알게 되고
2. 모티터링 대상이 응답하지 않는 경우도 파악할 수 있다.

### 데이터 수집

프로메테우스는 Scrape 라고 불리는 HTTP 요청을 보내 메트릭을 가져오는 작업을 수행한다. (프로메테우스: pull-based system)
데이터 수집 요청은 정기적으로 발생하며, 일반적으로 각 대상에 10-60 초마다 요청을 보내도록 구성할 수 있다.

### 저장 장치

프로메테우스는 로컬 머신에만 데이터를 저장해서, 저장되는 데이터의 양의 최대치는 해당 머신에 얼마나 많은 디스크 공간을 확보하냐에 따라 달라진다.
분산 시스템은 신뢰성을 확보하기가 어렵기 때문에, 어떠한 형태의 클러스터링 구성도 하지 않는다. 

### Dashboard 

프로메테우스는 raw data 를 요청하고 PromQL 쿼리를 수행할 수 있는, HTTP API 를 제공한다.
이러한 API 들은 그래프와 데쉬보드를 생성하는데 사용할 수 있다.

또한, expression browser 를 제공한다.
API 를 사용해 부가적인 쿼리와 데이터를 탐지하는데 적합하지만, 일반적인 데쉬보드 시스템은 아니다.
데쉬보드는, Grafana 의 사용이 권장된다.

### Recodring Rule, Alerting Rule

그래프를 그릴 때, 수천 대의 머신에서 들어오는 매트릭을 매번 집계하면 지연이 발생한다.
그래서, recoding rule 을 통해 PromQL 표현식을 정기적으로 수행하고, 이 결과를 저장 엔진에 저장할 수 있다.

alerting rule 은, PromQL 표현식을 정기적으로 수행하며, 이 표현식에 나오는 모든 결과가 알림이 된다.
알림은 알림 메니저로 보내진다.

### 알림 관리

알림매니저는 프로메테우스 서버에서 알림을 받아, notification 으로 변환한다.
notification 은 이메일, 슬랙 등의 서비스로 전송된다.

---

프로메테우스, 오픈소스 모니터링 시스템 <브라이언 브라질>
